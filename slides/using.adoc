

Using JGroups
=============
author: Bela Ban belaban@yahoo.com

Overview, API and configuration of the most common protocols.

What is it ?
------------
* Clustering library (only *a single JAR* (~2MB))
* Provides
** Reliable _one-to-many_ or _one-to-one_ communication
** Can use _IP multicasting_ or TCP
* Customizable _protocol stack_
** Users can add, remove, replace, enhance, or even write their own protocols

* Ships protocols for
** Network communication (transport)
** Membership discovery
** Failure detection
** Lossless and ordered transmission
** Network split handling and subsequent merging
** Notification when nodes join or leave the cluster (membership)
** Flow control
** Fragmentation
** Compression, encryption, authentication

* Building blocks
** Method invocation across a cluster
** Distributed caches, counters, locks


Architecture I
--------------
image::../images/arch.png["Architecture of JGroups,width="60%",align=left,valign=top]


Architecture II
---------------
* Users deal mainly with the _channel_ (`JChannel`)
* The protocol stack is setup according to an XML config file
* A sent message passes the stack _top-down_
* A received message is passed up through the stack _bottom-up_


Common classes
--------------
* `Address`
** Identifies a node (=member) in a cluster
** Can be used as destination to send a message to a node
** A node's address can be retrieved from the channel: `JChannel.getAddress()`

* `View`
** List of addresses, lists all cluster nodes
** Order is the same in all nodes
** Example: `A[4] (2) [A, B]`
*** View was created by (coordinator) A and the current cluster contains A and B

* `Message`
** This is sent and received by cluster nodes
** Destination and sender's addresses
*** Destination == null: send to entire cluster
** Payload (`byte[]` buffer)
** Flags
** Headers (used mainly by protocols to add information, e.g. sequence numbers)
* Example:
[source,java]
----
Message msg=new Message(null, "hello")      // "hello" is serialized into a byte[] buffer
                .setFlag(Message.Flag.OOB); // set flag OOB
channel.send(msg);
----

ReceiverAdapter
---------------
* Callback to receive messages (push-model) and view changes
* Users typically extend it and override `receive()` and `viewAccepted()`:
[source,java]
----
public void receive(Message) {
    Address sender=msg.getSrc();
    String greeting=(String)msg.getObject();
    System.out.println("received " + greeting + " from " + sender);
}

public void viewAccepted(View view) {
    System.out.println("received view " + view);
}
----



JChannel: overview
------------------
* A `JChannel` is used to represent a cluster node
* Simple API: create, connect, send / receive, disconnect, close
* Example:
[source,java]
----
// Create a channel, name it "A":
JChannel ch=new JChannel("/home/bela/udp.xml").name("A");

// Add a receiver to receive messages:
ch.setReceiver(new ReceiverAdapter() {
    public void receive(Message msg) {
        System.out.printf("msg from %s: %s\n", msg.getSrc(), msg.getObject());
    }
});

// Join the cluster "demo-cluster":
ch.connect("demo-cluster");

// Send a messaeg to all nodes (including myself):
Message msg=new Message(null, "hello world");
ch.send(msg);

// Disconnect and close the channel:
ch.close();
----


Creation of a channel
---------------------
* There are a number of constructors available:
[source,java]
----
public JChannel(); // creates a default channel (uses udp.xml)
public JChannel(File properties); // from a file
public JChannel(Element el); // from a DOM element
public JChannel(URL url); // from a URL
public JChannel(String props); // config file on the classpath
public JChannel(InputStream input); // input stream
public JChannel(Protocol ... protocols); // list of protocols (programmatic creation)
public JChannel(Collection<Protocol> protocols); // ditto
public JChannel(JChannel ch); // from another channel
----


Sample XML configuration file
-----------------------------
* _Bottom-up_: `UDP` is the transport protocol, `FRAG2` is the top protocol
* Attributes configure the protocols, e.g. `mcast_port` in `UDP`
* Attributes can use variables, e.g. `${jgroups.udp.mcast_port:45588}`
** System property `-Djgroups.udp.mcast_port=60000` overrides the (default) value of `45588`
[source,xml]
----
<config xmlns="urn:org:jgroups"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="urn:org:jgroups http://www.jgroups.org/schema/jgroups.xsd">
    <UDP mcast_port="${jgroups.udp.mcast_port:45588}" />
         
    <PING />
    <MERGE3 max_interval="30000"
            min_interval="10000"/>
    <FD_SOCK/>
    <FD_ALL/>
    <VERIFY_SUSPECT timeout="1500"  />
    <pbcast.NAKACK2 xmit_interval="500"
                    use_mcast_xmit="false"/>
    <UNICAST3 xmit_interval="500"
              conn_expiry_timeout="0" />
    <pbcast.STABLE desired_avg_gossip="50000"
                   max_bytes="4M"/>
    <pbcast.GMS print_local_addr="true" join_timeout="2000"
                view_bundling="true"/>
    <UFC max_credits="2M" min_threshold="0.4"/>
    <MFC max_credits="2M" min_threshold="0.4"/>
    <FRAG2 frag_size="60K"  />
</config>
----
